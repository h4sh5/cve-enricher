#!/usr/bin/env python3

import requests
import json
import sys
import os
import time
import datetime
import random
import re
from urllib.parse import quote_plus


GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")

CVE_PATTERN = r'(?i)\bcve\-\d{4}-\d{4,7}'

start = time.time()

def has_digits(s):
	return any(char.isdigit() for char in s)

def normalize_cve(cvestr):
	'''
	normalize a cve string to CVE-YYYY-ZZZZZ
	'''
	if not (cvestr.upper().startswith("CVE") and has_digits(cvestr) and len(cvestr) > 10): # validate it
		print(f"INFO: invalid cve str {cvestr}")
		return None
	cve = ''
	cve += cvestr[:3].upper() # first 3 chars
	if cvestr[3].isdigit(): #if the fourth char is a number e.g. cve202312345
		cve += f"-{cvestr[3:7]}-{cvestr[7:].replace('-','').replace('_','')}"
	elif cvestr[3] in ["_", "-"]:
		# a proper CVE string should also work, not just with underscore 
		cve += f"-{cvestr[4:8]}-{cvestr[9:]}"
	else:
		print(f"WARNING: weird cve str {cvestr}")
		return None
	return cve

def redhat_cve_detail(cve):
	'''
	get cve detail from redhats portal
	'''
	url = f'https://access.redhat.com/labs/securitydataapi/cve/{cve}.json'
	r = requests.get(url)
	if r.status_code != 200:
		print(f"WARN: bad redhat api status for {cve}", r.status_code, r.text)
	return r.json()

def ghsa_cve_detail(cve):
	'''
	get cve data from the github security advisory api
	https://docs.github.com/en/rest/security-advisories/global-advisories?apiVersion=2022-11-28
	'''

	time.sleep(2) # rate limit, just to be safe 

	headers = {"Accept": "application/vnd.github+json", "Authorization": f"Bearer {GITHUB_TOKEN}", "X-GitHub-Api-Version": "2022-11-28"}

	url = f'https://api.github.com/advisories?cve_id={cve}'

	r = requests.get(url, headers=headers)

	if r.status_code != 200:
		print("ERROR bad status code:", r.status_code, r.text)
		if 'API rate limit' in r.text :
			print("Exceeded API limit, sleeping..")
			time.sleep(10)

	return r.json()




def nvd_cve_detail(cve):
	'''
	get cve detail (like cvss score) from the nvd api 
	https://nvd.nist.gov/developers/vulnerabilities

	it's unreliable AF
	'''
	url = f'https://services.nvd.nist.gov/rest/json/cves/2.0?cveId={cve}'
	r = requests.get(url)
	# if r.status_code == 403:
	# 	print("rate limited by assholes at NVD, sleeping.. error message:", r.text)
	# 	time.sleep(6.1)
	# 	r = requests.get(url)
	if r.status_code == 403:
		return None
	if r.status_code not in [200, 403]:
		print(f"WARN: bad nvd api status for {cve}", r.status_code, r.text[:100])
		return None
	else:
		return r.json()

def get_nuclei_template(cve):
	'''
	use github's API to search and return nuclei template
	'''
	headers = {"Accept": "application/vnd.github+json", "Authorization": f"Bearer {GITHUB_TOKEN}", "X-GitHub-Api-Version": "2022-11-28"}
	q = f'repo:projectdiscovery/nuclei-templates {cve}'
	url = f'https://api.github.com/search/code?q={quote_plus(q)}'

	time.sleep(2)
	r = requests.get(url, headers=headers)

	if r.status_code != 200:
		print("ERROR bad status code:", r.status_code, r.text)
		if 'API rate limit' in r.text :
			print("Exceeded API limit, sleeping..")
			time.sleep(10)
			return get_nuclei_template(cve)

	d = r.json()
	if d['total_count'] > 0:
		for item in d['items']:
			if item['path'].endswith(f"{cve}.yaml"):
				return item['html_url']

	return None

def first_epss_for_cves_list(cves):
	'''
	get EPSS (Exploit Prediction Scoring System) detail for the list of cves
	'''
	print(f'getting epss data for {len(cves)} cves')
	data = []
	for i in range(0, len(cves), 30):
		cves_csv = ','.join(cves[i:i+30])
		r = requests.get(f'https://api.first.org/data/v1/epss?cve={cves_csv}')
		data.extend(r.json()['data'])
	return data


def get_github_repos(cve):

	github_repos = set() # use set to dedup; cast this back to a list later

	# bloody rate limit
	time.sleep(2)

	# search generically, without "in:.."
	# > When you omit this qualifier, only the repository name, description, and topics are searched.
	# in:readme sucks and returns false positives instead of actual PoCs
	url = f'https://api.github.com/search/repositories?q={cve}&per_page=100'
	headers = {'Accept':'application/vnd.github+json', 'Authorization': f'Bearer {GITHUB_TOKEN}', 'X-GitHub-Api-Version': '2022-11-28'}
	r = requests.get(url, headers=headers)

	if r.status_code != 200:
		print("ERROR bad status code:", r.status_code, r.text)
		if 'API rate limit' in r.text :
			print("Exceeded API limit, sleeping..")
			time.sleep(10)
		return ['#search_error']

	for d in r.json()['items']:
		github_repos.add(d['html_url'])

	return list(github_repos)


def main():

	if len(sys.argv) < 2:
		print("usage: %s <input file with cves>" % sys.argv[0])
		exit(1)

	if GITHUB_TOKEN == None:
		print("ERROR: GITHUB_TOKEN not supplied")
		exit(1)

	cves_found = []
	with open(sys.argv[1], 'r') as f:
		for line in f:
			cves_found.extend(re.findall(CVE_PATTERN, line))

	cves_found = list(set(cves_found)) # dedup
	cves = []
	for cve in cves_found:
		if normalize_cve(cve) != None:
			cves.append(normalize_cve(cve))


	print(f"total {len(cves)} CVEs")

	# get epss data
	print('getting EPSS data..')
	lstart = time.time()
	epss_data = first_epss_for_cves_list(cves)
	# XXX for debugging epss data
	# with open('epss.json','w') as f:
	# 	json.dump(epss_data, f, indent=2)
	print("done getting EPSS data: ", time.time()-lstart)


	print("getting CVE details...")
	lstart = time.time()
	cve_details = {}
	for cve in cves:
		cve_data = None
		try:
			cve_data = nvd_cve_detail(cve)
			if cve_data == None:
				print("NVD fell thru, using GHSA as a fallback")
				cve_data = ghsa_cve_detail(cve)
				if len(cve_data) == 0:
					cve_data = None
					print(f"WARNING: no cve data found on {cve}")
				else:
					cve_details[cve] = cve_data[0] # for GHSA a JSON list is returned, index the first result
			else:
				# NVD has a even worse schema
				cve_details[cve] = cve_data['vulnerabilities'][0]
		except Exception as e:
			print("Exception trying to get cve details:", e)



	# one big JSON blob for the page to render
	cve_feed = {} #cve:...

	print("done getting CVE details:", time.time()-lstart)

	print("getting github repos..")
	cve_repos = {} # cve:[repo_urls]
	lstart = time.time()
	for cve in cves:
		github_repos = get_github_repos(cve)
		cve_repos[cve] = github_repos
	print("done getting github repos:", time.time()-lstart)


	for cve in cves:
		cve_feed[cve] = {}
		cve_feed[cve]['cvss3'] = 0
		cve_feed[cve]['severity'] = None
		# cve_feed[cve]['epss'] = 0
		cve_feed[cve]['epss_severity'] = None
		cve_feed[cve]['nuclei'] = get_nuclei_template(cve)
		cve_feed[cve]['posts'] = []
		cve_feed[cve]['description'] = "N/A"
		cve_feed[cve]['repos'] = cve_repos[cve]

		for d in epss_data:
			if d['cve'] == cve:
				cve_feed[cve]['epss'] = float(d['epss']) * 100
				# epss severity is just done here for coloring; it's not part of any spec that defines levels
				if cve_feed[cve]['epss'] >= 50:
					cve_feed[cve]['epss_severity'] = "CRITICAL"
				elif cve_feed[cve]['epss'] >= 20:
					cve_feed[cve]['epss_severity'] = "HIGH"
				elif cve_feed[cve]['epss'] >= 10:
					cve_feed[cve]['epss_severity'] = "MEDIUM"
				else:
					cve_feed[cve]['epss_severity'] = "LOW"

		if 'epss' not in cve_feed[cve]:
			cve_feed[cve]['epss'] = 0

	

		if cve in cve_details:
			try:
				# Github security advisory db https://docs.github.com/en/rest/security-advisories/global-advisories?apiVersion=2022-11-28
				if 'description' in cve_details[cve]:  # GHSA
					if 'cvss' in cve_details[cve]:
						cve_feed[cve]['cvss3'] = cve_details[cve]['cvss']['score']
					if 'description' in cve_details[cve]:
						cve_feed[cve]['description'] = cve_details[cve]['description']
					# if 'severity' in cve_details[cve]:
					# 	cve_feed[cve]['severity'] = cve_details[cve]['severity'].upper()
					if cve_feed[cve]['cvss3'] > 0 and cve_feed[cve]['cvss3'] < 4:
						cve_feed[cve]['severity'] = 'LOW'
					elif cve_feed[cve]['cvss3'] > 4 and cve_feed[cve]['cvss3'] < 7:
						cve_feed[cve]['severity'] = 'MEDIUM'
					elif cve_feed[cve]['cvss3'] > 7 and cve_feed[cve]['cvss3'] < 9:
						cve_feed[cve]['severity'] = 'HIGH'
					elif cve_feed[cve]['cvss3'] > 9:
						cve_feed[cve]['severity'] = 'CRITICAL'


					continue


				################### CODE PARSING NVD API ##############
				# The schema sucks
				if 'impact' in cve_details[cve]:
					if 'baseMetricV3' in cve_details[cve]['impact']:
						cve_feed[cve]['cvss3'] = cve_details[cve]['impact']['baseMetricV3']['cvssV3']['baseScore']
						cve_feed[cve]['severity'] = cve_details[cve]['impact']['baseMetricV3']['cvssV3']['baseSeverity']

				elif 'metrics' in cve_details[cve]['cve']:
					if 'cvssMetricV30' in cve_details[cve]['cve']['metrics']:
						cve_feed[cve]['cvss3'] = cve_details[cve]['cve']['metrics']['cvssMetricV30'][0]['cvssData']['baseScore']
						cve_feed[cve]['severity'] = cve_details[cve]['cve']['metrics']['cvssMetricV30'][0]['cvssData']['baseSeverity']
					if 'cvssMetricV31' in cve_details[cve]['cve']['metrics']:
						cve_feed[cve]['cvss3'] = cve_details[cve]['cve']['metrics']['cvssMetricV31'][0]['cvssData']['baseScore']
						cve_feed[cve]['severity'] = cve_details[cve]['cve']['metrics']['cvssMetricV31'][0]['cvssData']['baseSeverity']



				if 'description' in cve_details[cve]['cve'] and len(cve_details[cve]['cve']['description']['description_data']) > 0:
					cve_feed[cve]['description'] = cve_details[cve]['cve']['description']['description_data'][0]['value']
				elif 'descriptions' in cve_details[cve]['cve'] and len(cve_details[cve]['cve']['descriptions']) > 0:
					cve_feed[cve]['description'] = cve_details[cve]['cve']['descriptions'][0]['value']


			except Exception as e:
				print(f"Error parsing cve detail on {cve}:", e, cve_details[cve])



	outfile = 'cve_feed.json'
	with open(outfile, 'w+') as f:
		json.dump(cve_feed, f, indent=2)

	from renderer import render
	render(outfile)

	print(f'done, written output to {outfile}. total elapsed:', time.time() - start)

if __name__ == "__main__":
	main()
